<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MartinaTrade — MartinaAI Trading Bot</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c0a0f;
      --surface: #15121a;
      --surface2: #1e1a24;
      --border: #2d2835;
      --text: #f0ebf4;
      --textMuted: #9089a0;
      --accent: #c9a227;
      --accentDim: #a68520;
      --success: #4ade80;
      --danger: #f87171;
      --radius: 12px;
      --radiusSm: 8px;
      --font: 'Outfit', system-ui, sans-serif;
      --fontMono: 'IBM Plex Mono', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 70% 40% at 50% -10%, rgba(201, 162, 39, 0.06), transparent),
                        radial-gradient(ellipse 50% 30% at 80% 80%, rgba(201, 162, 39, 0.04), transparent);
    }
    .app {
      max-width: 560px;
      margin: 0 auto;
      padding: 28px 20px;
      min-height: 100vh;
    }
    header {
      text-align: center;
      margin-bottom: 28px;
    }
    h1 {
      font-size: 1.85rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    h1 span { color: var(--accent); }
    .sub { font-size: 0.9rem; color: var(--textMuted); margin-top: 6px; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      width: 100%;
      margin-bottom: 16px;
    }
    .card h2 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--textMuted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 14px;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row:last-child { margin-bottom: 0; }
    .label {
      font-size: 0.75rem;
      color: var(--textMuted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }
    .inputWrap {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radiusSm);
      padding: 12px 14px;
      transition: border-color 0.2s;
    }
    .inputWrap:focus-within { border-color: var(--accent); }
    .inputWrap input {
      width: 100%;
      background: none;
      border: none;
      color: var(--text);
      font-size: 1rem;
      font-family: var(--fontMono);
    }
    .inputWrap input::placeholder { color: var(--textMuted); }
    .inputWrap input:focus { outline: none; }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--radiusSm);
      font-family: var(--font);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btnPrimary {
      background: var(--accent);
      color: var(--bg);
    }
    .btnPrimary:hover:not(:disabled) { background: var(--accentDim); }
    .btnPrimary:disabled { background: var(--surface2); color: var(--textMuted); cursor: not-allowed; }
    .btnSecondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btnSecondary:hover { border-color: var(--accent); color: var(--accent); }
    .btnConnect {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accentDim) 100%);
      color: var(--bg);
      padding: 14px 28px;
      border-radius: var(--radius);
    }
    .btnConnect:hover { filter: brightness(1.1); }
    .status { font-size: 0.85rem; color: var(--textMuted); margin-top: 12px; text-align: center; }
    .status.error { color: var(--danger); }
    .status.success { color: var(--success); }
    .infoGrid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 16px;
      font-size: 0.9rem;
    }
    .infoGrid dt { color: var(--textMuted); font-family: var(--fontMono); font-size: 0.8rem; }
    .infoGrid dd { word-break: break-all; }
    .orderRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .orderRow:last-child { border-bottom: none; }
    .orderId { font-family: var(--fontMono); color: var(--accent); }
    .orderStatus { font-size: 0.8rem; color: var(--textMuted); }
    .orderStatus.filled { color: var(--success); }
    .orderStatus.cancelled { color: var(--danger); }
    .footer { margin-top: 24px; font-size: 0.8rem; color: var(--textMuted); text-align: center; }
    .footer a { color: var(--accent); text-decoration: none; }
    #ordersList { max-height: 280px; overflow-y: auto; }
    #connectWrap { text-align: center; padding: 36px 24px; }
    .network { font-size: 0.85rem; color: var(--textMuted); margin-bottom: 14px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Martina<span>Trade</span></h1>
      <p class="sub">MartinaAI trading bot — place and execute orders</p>
    </header>

    <div id="connectWrap" class="card">
      <p class="network" id="networkLabel">Connect wallet</p>
      <button type="button" class="btn btnConnect" id="connectBtn">Connect wallet</button>
    </div>

    <div id="mainWrap" style="display: none;">
      <div class="network" id="networkName"></div>

      <div class="card">
        <h2>Contract info</h2>
        <dl class="infoGrid" id="infoGrid"></dl>
      </div>

      <div class="card">
        <h2>Orders</h2>
        <div id="ordersList"></div>
        <div style="margin-top: 12px;">
          <button type="button" class="btn btnSecondary" id="refreshOrdersBtn">Refresh orders</button>
        </div>
      </div>

      <div class="card" id="placeOrderCard">
        <h2>Place order (operator only)</h2>
        <div class="row">
          <div style="flex: 1;">
            <div class="label">Token In</div>
            <div class="inputWrap">
              <input type="text" id="orderTokenIn" placeholder="0x..." />
            </div>
          </div>
        </div>
        <div class="row">
          <div style="flex: 1;">
            <div class="label">Token Out</div>
            <div class="inputWrap">
              <input type="text" id="orderTokenOut" placeholder="0x..." />
            </div>
          </div>
        </div>
        <div class="row">
          <div style="flex: 1;">
            <div class="label">Amount In</div>
            <div class="inputWrap">
              <input type="text" id="orderAmountIn" placeholder="0" inputmode="decimal" />
            </div>
          </div>
        </div>
        <div class="row">
          <div style="flex: 1;">
            <div class="label">Amount Out Min</div>
            <div class="inputWrap">
              <input type="text" id="orderAmountOutMin" placeholder="0" inputmode="decimal" />
            </div>
          </div>
        </div>
        <button type="button" class="btn btnPrimary" id="placeOrderBtn" style="width: 100%; margin-top: 8px;">Place order</button>
      </div>

      <div class="card">
        <h2>Execute order</h2>
        <div class="row">
          <div style="flex: 1;">
            <div class="label">Order ID</div>
            <div class="inputWrap">
              <input type="number" id="executeOrderId" placeholder="1" min="1" />
            </div>
          </div>
        </div>
        <button type="button" class="btn btnPrimary" id="executeOrderBtn" style="width: 100%; margin-top: 8px;">Execute order</button>
      </div>

      <p class="status" id="status"></p>
    </div>

    <p class="footer">MartinaAI trading bot. Use at your own risk.</p>
  </div>

  <script>
    (function () {
      const CONTRACT_ADDRESS = '0x0000000000000000000000000000000000000000';
      const CHAIN_NAMES = { 1: 'Ethereum', 5: 'Goerli', 137: 'Polygon', 42161: 'Arbitrum', 8453: 'Base' };
      const ABI = [
        'function martinaOperator() view returns (address)',
        'function router() view returns (address)',
        'function treasury() view returns (address)',
        'function vault() view returns (address)',
        'function botPaused() view returns (bool)',
        'function orderCounter() view returns (uint256)',
        'function genesisBlock() view returns (uint256)',
        'function getOrder(uint256 orderId) view returns (address tokenIn, address tokenOut, uint256 amountIn, uint256 amountOutMin, uint256 deadline, bool filled, bool cancelled, uint256 placedAtBlock)',
        'function placeOrder(address tokenIn, address tokenOut, uint256 amountIn, uint256 amountOutMin, uint256 deadline) returns (uint256 orderId)',
        'function executeOrder(uint256 orderId) returns (uint256 amountOut)',
        'function cancelOrder(uint256 orderId)'
      ];
      const DEADLINE_OFFSET = 600;

      let provider = null;
      let signer = null;
      let contract = null;
      let chainId = null;
      let userAddress = null;

      const connectWrap = document.getElementById('connectWrap');
      const mainWrap = document.getElementById('mainWrap');
      const networkLabel = document.getElementById('networkLabel');
      const networkName = document.getElementById('networkName');
      const infoGrid = document.getElementById('infoGrid');
      const ordersList = document.getElementById('ordersList');
      const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
      const placeOrderCard = document.getElementById('placeOrderCard');
      const placeOrderBtn = document.getElementById('placeOrderBtn');
      const orderTokenIn = document.getElementById('orderTokenIn');
      const orderTokenOut = document.getElementById('orderTokenOut');
      const orderAmountIn = document.getElementById('orderAmountIn');
      const orderAmountOutMin = document.getElementById('orderAmountOutMin');
      const executeOrderId = document.getElementById('executeOrderId');
      const executeOrderBtn = document.getElementById('executeOrderBtn');
      const statusEl = document.getElementById('status');

      function setStatus(msg, type) {
        statusEl.textContent = msg || '';
        statusEl.className = 'status' + (type ? ' ' + type : '');
      }

      function showMain() {
        connectWrap.style.display = 'none';
        mainWrap.style.display = 'block';
        networkName.textContent = CHAIN_NAMES[chainId] || 'Chain ' + chainId;
      }

      function hideMain() {
        mainWrap.style.display = 'none';
        connectWrap.style.display = 'block';
      }

      async function loadInfo() {
        if (!contract) return;
        try {
          const [operator, routerAddr, treasuryAddr, vaultAddr, paused, count, genesis] = await Promise.all([
            contract.martinaOperator(),
            contract.router(),
            contract.treasury(),
            contract.vault(),
            contract.botPaused(),
            contract.orderCounter(),
            contract.genesisBlock(),
          ]);
          infoGrid.innerHTML = ''
            + '<dt>Operator</dt><dd>' + operator + '</dd>'
            + '<dt>Router</dt><dd>' + routerAddr + '</dd>'
            + '<dt>Treasury</dt><dd>' + treasuryAddr + '</dd>'
            + '<dt>Vault</dt><dd>' + vaultAddr + '</dd>'
            + '<dt>Paused</dt><dd>' + (paused ? 'Yes' : 'No') + '</dd>'
            + '<dt>Order count</dt><dd>' + count.toString() + '</dd>'
            + '<dt>Genesis block</dt><dd>' + genesis.toString() + '</dd>';
          const isOp = userAddress && userAddress.toLowerCase() === operator.toLowerCase();
          placeOrderCard.style.display = isOp ? 'block' : 'none';
        } catch (e) {
          infoGrid.innerHTML = '<dd class="status error">Failed to load: ' + (e.message || 'unknown') + '</dd>';
        }
      }

      async function loadOrders() {
        if (!contract) return;
        try {
          const count = Number(await contract.orderCounter());
          ordersList.innerHTML = '';
          if (count === 0) {
            ordersList.innerHTML = '<p class="orderStatus">No orders yet.</p>';
            return;
          }
          for (let i = 1; i <= count; i++) {
            try {
              const o = await contract.getOrder(i);
              const status = o.filled ? 'filled' : (o.cancelled ? 'cancelled' : 'open');
              const statusClass = o.filled ? 'filled' : (o.cancelled ? 'cancelled' : '');
              ordersList.innerHTML += '<div class="orderRow">'
                + '<span class="orderId">#' + i + '</span> '
                + '<span>' + o.tokenIn.slice(0, 8) + '… → ' + o.tokenOut.slice(0, 8) + '…</span> '
                + '<span class="orderStatus ' + statusClass + '">' + status + '</span>'
                + '</div>';
            } catch (_) {
              ordersList.innerHTML += '<div class="orderRow"><span class="orderId">#' + i + '</span> <span class="orderStatus">—</span></div>';
            }
          }
        } catch (e) {
          ordersList.innerHTML = '<p class="status error">Failed to load orders.</p>';
        }
      }

      async function connect() {
        if (!window.ethereum) {
          setStatus('No wallet found. Install MetaMask or another Web3 wallet.', 'error');
          return;
        }
        try {
          provider = new ethers.BrowserProvider(window.ethereum);
          const accounts = await provider.send('eth_requestAccounts', []);
          if (!accounts.length) return;
          signer = await provider.getSigner();
          userAddress = await signer.getAddress();
          const net = await provider.getNetwork();
          chainId = Number(net.chainId);
          networkLabel.textContent = CHAIN_NAMES[chainId] || 'Chain ' + chainId;
          if (CONTRACT_ADDRESS === '0x0000000000000000000000000000000000000000') {
            setStatus('Set CONTRACT_ADDRESS in the script to your deployed MartinaAI contract.', 'error');
            return;
          }
          contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          showMain();
          await loadInfo();
          await loadOrders();
          setStatus('');
        } catch (e) {
          setStatus(e.message || 'Connection failed', 'error');
        }
      }

      refreshOrdersBtn.addEventListener('click', function () {
        loadOrders();
        loadInfo();
        setStatus('Refreshed.');
      });

      placeOrderBtn.addEventListener('click', async function () {
        if (!contract || !signer) return;
        const tokenIn = orderTokenIn.value.trim();
        const tokenOut = orderTokenOut.value.trim();
        const amountIn = orderAmountIn.value.trim();
        const amountOutMin = orderAmountOutMin.value.trim();
        if (!tokenIn || !tokenOut || !amountIn || !amountOutMin) {
          setStatus('Fill all order fields.', 'error');
          return;
        }
        const amountInWei = ethers.parseUnits(amountIn, 18);
        const amountOutMinWei = ethers.parseUnits(amountOutMin, 18);
        const deadline = Math.floor(Date.now() / 1000) + DEADLINE_OFFSET;
        setStatus('Confirm in wallet…');
        try {
          const tx = await contract.placeOrder(tokenIn, tokenOut, amountInWei, amountOutMinWei, deadline);
          await tx.wait();
          setStatus('Order placed. Tx: ' + tx.hash.slice(0, 10) + '…', 'success');
          orderTokenIn.value = '';
          orderTokenOut.value = '';
          orderAmountIn.value = '';
